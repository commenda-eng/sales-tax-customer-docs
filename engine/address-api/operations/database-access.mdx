---
title: Database access
description: Connect to the Address API database
---

This guide explains how to connect to the PostgreSQL database in staging and production environments.

## Database architecture

The Address API uses Amazon RDS PostgreSQL 15 in private subnets. Direct access is not possible from the internet. You must connect through a bastion host.

## Prerequisites

- AWS CLI configured with appropriate credentials
- Session Manager plugin installed
- Database credentials from AWS Secrets Manager

## Step 1: Configure security group

Before connecting, you need to allow traffic from the bastion host to the database.

### Add inbound rule

1. Go to **EC2** → **Security Groups**
2. Search for `staging-address-api-postgres-sg` (or `prod-address-api-postgres-sg`)
3. Click on the security group
4. Click **Edit inbound rules**
5. Click **Add rule**
6. Configure:
   - **Type**: All traffic
   - **Source type**: Anywhere-IPv4
   - **Description**: Temporary access for debugging
7. Click **Save rules**

**⚠️ Important**: Remove this rule after you're done to maintain security.

## Step 2: Connect to bastion host

### Using AWS Console

1. Go to **EC2** → **Instances**
2. Search for `staging-bastion-host` (or `prod-bastion-host`)
3. Select the instance
4. Click **Connect**
5. Select **Session Manager** tab
6. Click **Connect**

### Using AWS CLI

```bash
# Staging
aws ssm start-session \\\n  --target i-xxxxxxxxxxxxxxxxx \\\n  --region ap-south-1 \\\n  --profile staging

# Production
aws ssm start-session \\\n  --target i-xxxxxxxxxxxxxxxxx \\\n  --region ap-south-1 \\\n  --profile prod
```

## Step 3: Get database credentials

### From AWS Secrets Manager

```bash
# Staging
aws secretsmanager get-secret-value \\\n  --secret-id staging-address-api-secrets \\\n  --region ap-south-1 \\\n  --profile staging \\\n  --query SecretString \\\n  --output text | jq -r

# Production
aws secretsmanager get-secret-value \\\n  --secret-id prod-address-api-secrets \\\n  --region ap-south-1 \\\n  --profile prod \\\n  --query SecretString \\\n  --output text | jq -r
```

This returns JSON with:
- `RDS_USERNAME`
- `RDS_PASSWORD`
- `RDS_HOSTNAME`
- `RDS_PORT`
- `RDS_DBNAME`

## Step 4: Connect to PostgreSQL

Once connected to the bastion host, use `psql` to connect to the database:

```bash
# Construct connection URL
psql postgresql://username:password@hostname:5432/dbname

# Example
psql postgresql://postgres:mypassword@staging-address-api-db.xxxxx.ap-south-1.rds.amazonaws.com:5432/address_api
```

## Common database operations

### List tables

```sql
\dt
```

Output:
```
 Schema |         Name          | Type  |  Owner
--------+-----------------------+-------+----------
 public | address_cache         | table | postgres
 public | api_key               | table | postgres
 public | atlas_schema_revisions| table | postgres
 public | iso_3166              | table | postgres
```

### View table schema

```sql
\d address_cache
\d api_key
\d iso_3166
```

### Query data

```sql
-- View cached addresses
SELECT original_address, city, state, country_code, cached_at
FROM address_cache
ORDER BY created_at DESC
LIMIT 10;

-- View API keys
SELECT id, organization_name, roles, created_at
FROM api_key;

-- View ISO 3166 content
SELECT country_code, subdivision_code, subdivision_name
FROM iso_3166
WHERE country_code = 'US'
ORDER BY subdivision_name;
```

### Check database size

```sql
SELECT pg_size_pretty(pg_database_size('address_api'));
```

### Check table sizes

```sql
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### View active connections

```sql
SELECT
  pid,
  usename,
  application_name,
  client_addr,
  state,
  query_start,
  state_change
FROM pg_stat_activity
WHERE datname = 'address_api';
```

## Database maintenance

### Vacuum tables

```sql
-- Analyze and vacuum all tables
VACUUM ANALYZE;

-- Vacuum specific table
VACUUM ANALYZE address_cache;
```

### Check for bloat

```sql
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
  n_dead_tup,
  n_live_tup,
  round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio
FROM pg_stat_user_tables
WHERE schemaname = 'public'
ORDER BY n_dead_tup DESC;
```

## Troubleshooting

### Cannot connect to bastion host

**Error**: "TargetNotConnected"

**Cause**: Bastion host is not running or Session Manager agent is not installed.

**Fix**:
1. Check instance state in EC2 console
2. Ensure instance has SSM agent installed
3. Verify IAM role has SSM permissions

### Cannot connect to database

**Error**: "could not connect to server"

**Cause**: Security group rules are blocking traffic.

**Fix**:
1. Verify security group inbound rules
2. Check database endpoint is correct
3. Ensure database is running (check RDS console)

### Connection timeout

**Error**: "timeout"

**Cause**: Database is in private subnet and security group is blocking.

**Fix**:
1. Add security group rule (see Step 1)
2. Verify you're connecting from bastion host
3. Check VPC routing tables

### Authentication failed

**Error**: "password authentication failed"

**Cause**: Incorrect credentials.

**Fix**:
1. Get fresh credentials from Secrets Manager
2. Ensure you're using the correct environment (staging vs prod)
3. Check for special characters in password (may need escaping)

## Security best practices

- **Remove security group rules** after debugging
- **Use read-only user** for queries (create separate user)
- **Never expose database publicly**
- **Rotate credentials regularly**
- **Audit database access** via CloudWatch logs
- **Use IAM authentication** for production access (future enhancement)

## Creating a read-only user

For safer database access, create a read-only user:

```sql
-- Create read-only user
CREATE USER readonly_user WITH PASSWORD 'secure_password';

-- Grant connect permission
GRANT CONNECT ON DATABASE address_api TO readonly_user;

-- Grant usage on schema
GRANT USAGE ON SCHEMA public TO readonly_user;

-- Grant select on all tables
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- Grant select on future tables
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT ON TABLES TO readonly_user;
```

## Next steps

- [Debugging guide](/engine/address-api/operations/debugging)
- [Monitoring](/engine/address-api/operations/monitoring)
- [Troubleshooting](/engine/address-api/operations/troubleshooting)
