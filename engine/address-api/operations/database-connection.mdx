---
title: Database connection
description: Connect to the Address API database
---

The Address API uses Amazon RDS PostgreSQL for data storage. This guide explains how to connect to the database for debugging and maintenance.

## Database overview

| Environment | Instance | Engine | Version |
|-------------|----------|--------|---------|
| Staging | `staging-address-api-postgres` | PostgreSQL | 15 |
| Production | `prod-address-api-postgres` | PostgreSQL | 15 |

## Connection methods

### Method 1: Via bastion host (recommended)

The databases are in private subnets and can only be accessed through a bastion host.

#### Step 1: Configure security group

1. Go to **AWS Console** → **EC2** → **Security Groups**
2. Search for `staging-address-api-postgres-sg` (or `prod-address-api-postgres-sg`)
3. Click on the security group
4. Click **Edit inbound rules**
5. Click **Add rule**
6. Configure the rule:
   - **Type**: All traffic
   - **Source type**: Anywhere-IPv4
   - **Source**: 0.0.0.0/0
7. Click **Save rules**

**⚠️ Security note**: This opens the database to all traffic from the bastion host. Remove this rule after you're done.

#### Step 2: Connect to bastion host

1. Go to **AWS Console** → **EC2** → **Instances**
2. Find `staging-bastion-host` (or `prod-bastion-host`)
3. Click **Connect**
4. Select **Session Manager**
5. Click **Connect**

You'll be connected to the bastion host terminal.

#### Step 3: Get database credentials

1. Go to **AWS Console** → **Secrets Manager**
2. Find `staging-address-api-secrets` (or `prod-address-api-secrets`)
3. Click on the secret
4. Click **Retrieve secret value**
5. Copy the credentials:
   - `RDS_USERNAME`
   - `RDS_PASSWORD`
   - `RDS_HOSTNAME`
   - `RDS_PORT`
   - `RDS_DBNAME`

#### Step 4: Connect to database

In the bastion host terminal:

```bash
psql postgresql://USERNAME:PASSWORD@HOSTNAME:PORT/DBNAME
```

Example:
```bash
psql postgresql://postgres:mypassword@staging-address-api-postgres.abc123.ap-south-1.rds.amazonaws.com:5432/address_api
```

### Method 2: Via SSH tunnel (for local tools)

If you want to use local database tools (DBeaver, pgAdmin, etc.):

#### Step 1: Set up SSH tunnel

```bash
# Get bastion host instance ID
aws ec2 describe-instances \
  --filters \"Name=tag:Name,Values=staging-bastion-host\" \
  --query \"Reservations[0].Instances[0].InstanceId\" \
  --output text \
  --region ap-south-1 \
  --profile staging

# Create SSH tunnel
aws ssm start-session \
  --target INSTANCE_ID \
  --document-name AWS-StartPortForwardingSessionToRemoteHost \
  --parameters '{\"host\":[\"RDS_HOSTNAME\"],\"portNumber\":[\"5432\"],\"localPortNumber\":[\"5433\"]}' \
  --region ap-south-1 \
  --profile staging
```

#### Step 2: Connect with local tool

Now you can connect to `localhost:5433` with your database tool:

- **Host**: `localhost`
- **Port**: `5433`
- **Database**: `address_api`
- **Username**: From Secrets Manager
- **Password**: From Secrets Manager

## Common database queries

### View all tables

```sql
\dt
```

Output:
```
 Schema |         Name          | Type  |  Owner
--------+-----------------------+-------+----------
 public | address_cache         | table | postgres
 public | api_key               | table | postgres
 public | atlas_schema_revisions| table | postgres
 public | iso_3166              | table | postgres
```

### Check ISO 3166 content

```sql
SELECT * FROM iso_3166 LIMIT 10;
```

### Check address cache

```sql
SELECT 
  original_address,
  city,
  state,
  state_code,
  country_code,
  cached_at
FROM address_cache
ORDER BY cached_at DESC
LIMIT 10;
```

### Check API keys

```sql
SELECT 
  id,
  organization_name,
  roles,
  created_at
FROM api_key;
```

### View database size

```sql
SELECT 
  pg_size_pretty(pg_database_size('address_api')) as database_size;
```

### View table sizes

```sql
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### Check active connections

```sql
SELECT 
  datname,
  usename,
  application_name,
  client_addr,
  state,
  query
FROM pg_stat_activity
WHERE datname = 'address_api';
```

## Database maintenance

### Clear address cache

```sql
-- Clear all cached addresses
TRUNCATE address_cache;

-- Clear specific address
DELETE FROM address_cache WHERE original_address = '94108, CA, US';

-- Clear old cache entries (older than 30 days)
DELETE FROM address_cache 
WHERE cached_at < EXTRACT(EPOCH FROM NOW() - INTERVAL '30 days');
```

### Add API key

```sql
INSERT INTO api_key (key, organization_name, roles)
VALUES ('your-api-key-here', 'Organization Name', ARRAY['GEOCODE', 'MANAGE_CONTENT']);
```

### Revoke API key

```sql
DELETE FROM api_key WHERE key = 'api-key-to-revoke';
```

### Update ISO 3166 content

```sql
-- Update subdivision name
UPDATE iso_3166
SET subdivision_name = 'New Name'
WHERE country_code = 'US' AND subdivision_code = 'CA';

-- Add new subdivision
INSERT INTO iso_3166 (country_code, subdivision_code, subdivision_name, subdivision_local_variant)
VALUES ('US', 'PR', 'Puerto Rico', NULL);
```

## Database migrations

### View migration history

```sql
SELECT * FROM atlas_schema_revisions ORDER BY executed_at DESC;
```

### Apply migrations manually

If a migration fails during deployment:

1. Connect to the database
2. Check the failed migration in `atlas_schema_revisions`
3. Fix the issue (e.g., remove duplicate data)
4. Re-run the migration:

```bash
atlas migrate apply \
  --dir \"file://database/migrations\" \
  --url \"postgresql://USERNAME:PASSWORD@HOSTNAME:PORT/DBNAME\"
```

## Troubleshooting

### Error: \"could not connect to server\"

**Cause**: Security group not configured or bastion host not accessible.

**Fix**:
1. Verify security group rules
2. Ensure bastion host is running
3. Check VPC and subnet configuration

### Error: \"password authentication failed\"

**Cause**: Incorrect credentials.

**Fix**:
1. Verify credentials in Secrets Manager
2. Ensure you're using the correct environment (staging vs prod)
3. Check for special characters in password (may need escaping)

### Error: \"database does not exist\"

**Cause**: Wrong database name.

**Fix**:
1. Check `RDS_DBNAME` in Secrets Manager
2. List available databases: `\l` in psql

### Connection times out

**Cause**: Security group rules not allowing traffic.

**Fix**:
1. Add inbound rule to security group
2. Verify bastion host can reach RDS instance
3. Check network ACLs

## Security best practices

- **Remove security group rules**: After debugging, remove the \"All traffic\" rule
- **Use read-only user**: Create a read-only user for querying
- **Audit database access**: Monitor CloudWatch logs for database connections
- **Rotate credentials**: Regularly update database passwords in Secrets Manager
- **Use IAM authentication**: Consider using IAM database authentication instead of passwords

## Next steps

- [Debugging guide](/engine/address-api/operations/debugging)
- [Common failures](/engine/address-api/operations/common-failures)
