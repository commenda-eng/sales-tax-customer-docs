---
title: Debugging
description: How to debug issues and check logs for the Address API
---

This guide explains how to debug issues in the Address API using CloudWatch logs and other AWS tools.

## CloudWatch Logs

The Address API logs all requests, responses, and errors to AWS CloudWatch.

### Log groups

**TODO: Specify the exact log group name**

| Environment | Log Group | Region |
|-------------|-----------|--------|
| Staging | `/ecs/staging-address-api` (?) | ap-south-1 |
| Production | `/ecs/prod-address-api` (?) | ap-south-1 |

### Viewing logs in AWS Console

1. Go to [CloudWatch Logs](https://ap-south-1.console.aws.amazon.com/cloudwatch/home?region=ap-south-1#logsV2:log-groups)
2. Search for the log group (e.g., `/ecs/address-api`)
3. Click on the log group
4. Click on a log stream (usually named by task ID)
5. View logs

### Viewing logs with AWS CLI

#### Tail logs in real-time

```bash
# Staging
aws logs tail /ecs/staging-address-api \\
  --follow \\
  --region ap-south-1

# Production
aws logs tail /ecs/prod-address-api \\
  --follow \\
  --region ap-south-1
```

#### Search logs

```bash
# Search for errors
aws logs filter-log-events \\
  --log-group-name /ecs/staging-address-api \\
  --filter-pattern "ERROR" \\
  --start-time $(date -u -d '1 hour ago' +%s)000 \\
  --region ap-south-1

# Search for specific request
aws logs filter-log-events \\
  --log-group-name /ecs/staging-address-api \\
  --filter-pattern "geoencode" \\
  --start-time $(date -u -d '1 hour ago' +%s)000 \\
  --region ap-south-1
```

#### Get logs for specific time range

```bash
aws logs filter-log-events \\
  --log-group-name /ecs/staging-address-api \\
  --start-time 1734518400000 \\
  --end-time 1734522000000 \\
  --region ap-south-1
```

## Log format

The Address API uses [zerolog](https://github.com/rs/zerolog) for structured JSON logging.

### Log structure

```json
{
  "level": "info",
  "time": 1734518400,
  "message": "request completed",
  "method": "POST",
  "path": "/api/v1/geoencode",
  "status": 200,
  "duration_ms": 245,
  "ip": "203.0.113.1",
  "user_agent": "curl/7.68.0"
}
```

### Log levels

| Level | Description | When to use |
|-------|-------------|-------------|
| `debug` | Detailed debugging information | Development only |
| `info` | General informational messages | Normal operations |
| `warn` | Warning messages | Potential issues |
| `error` | Error messages | Errors that need attention |
| `fatal` | Fatal errors | Application crashes |

### Common log patterns

#### Successful request

```json
{
  "level": "info",
  "time": 1734518400,
  "message": "request completed",
  "method": "POST",
  "path": "/api/v1/geoencode",
  "status": 200,
  "duration_ms": 245
}
```

#### Failed request

```json
{
  "level": "error",
  "time": 1734518400,
  "message": "request failed",
  "method": "POST",
  "path": "/api/v1/geoencode",
  "status": 500,
  "error": "database connection failed",
  "duration_ms": 5000
}
```

#### Database query

```json
{
  "level": "debug",
  "time": 1734518400,
  "message": "database query executed",
  "query": "SELECT * FROM address_cache WHERE address = $1",
  "duration_ms": 12
}
```

## Unified logging schema

**TODO: Define a unified logging schema**

Currently, there is no unified logging schema across services. We should establish one that includes:

- Standard fields (timestamp, level, message, service, environment)
- Request context (request_id, user_id, api_key_id)
- Performance metrics (duration, database_time, external_api_time)
- Error details (error_code, error_type, stack_trace)

Proposed schema:

```json
{
  "timestamp": "2024-12-18T12:00:00Z",
  "level": "info",
  "service": "address-api",
  "environment": "staging",
  "version": "v0.1.0",
  "request_id": "req_abc123",
  "message": "request completed",
  "http": {
    "method": "POST",
    "path": "/api/v1/geoencode",
    "status": 200,
    "duration_ms": 245,
    "ip": "203.0.113.1",
    "user_agent": "curl/7.68.0"
  },
  "auth": {
    "api_key_id": 123,
    "organization": "Acme Corp"
  },
  "performance": {
    "database_ms": 45,
    "external_api_ms": 180,
    "total_ms": 245
  }
}
```

## CloudWatch Insights queries

Use CloudWatch Insights for advanced log analysis.

### Query examples

#### Count requests by status code

```
fields @timestamp, status
| stats count() by status
| sort count desc
```

#### Average response time

```
fields @timestamp, duration_ms
| stats avg(duration_ms) as avg_duration, max(duration_ms) as max_duration
| sort avg_duration desc
```

#### Error rate

```
fields @timestamp, level
| filter level = "error"
| stats count() as error_count by bin(5m)
```

#### Slow requests

```
fields @timestamp, path, duration_ms
| filter duration_ms > 1000
| sort duration_ms desc
| limit 20
```

#### Requests by endpoint

```
fields @timestamp, path
| stats count() by path
| sort count desc
```

## Debugging common issues

### Issue: High response times

**Steps**:

1. Check CloudWatch logs for slow requests:
   ```
   fields @timestamp, path, duration_ms
   | filter duration_ms > 1000
   | sort duration_ms desc
   ```

2. Check database connection pool:
   ```bash
   curl https://address-api.in.staging.commenda.io/healthz
   ```

3. Check external API (Google) latency in logs

4. Check RDS performance metrics in AWS Console

### Issue: 500 errors

**Steps**:

1. Search for error logs:
   ```bash
   aws logs filter-log-events \\
     --log-group-name /ecs/staging-address-api \\
     --filter-pattern "ERROR" \\
     --region ap-south-1
   ```

2. Check error message and stack trace

3. Verify database connectivity:
   ```bash
   # Connect to database
   # See: /engine/address-api/operations/database-connection
   ```

4. Check environment variables in ECS task definition

### Issue: 401/403 errors

**Steps**:

1. Verify API key exists:
   ```sql
   SELECT * FROM api_key WHERE key = 'your-api-key';
   ```

2. Check API key roles:
   ```sql
   SELECT key, roles FROM api_key WHERE key = 'your-api-key';
   ```

3. Verify endpoint requires correct role

### Issue: Application not starting

**Steps**:

1. Check ECS task logs:
   ```bash
   # Get task ARN
   aws ecs list-tasks \\
     --cluster staging-ecs-cluster \\
     --service-name address-api \\
     --region ap-south-1

   # Describe task
   aws ecs describe-tasks \\
     --cluster staging-ecs-cluster \\
     --tasks TASK_ARN \\
     --region ap-south-1
   ```

2. Check CloudWatch logs for startup errors

3. Verify environment variables

4. Check database connectivity

## ECS debugging

### Check service status

```bash
aws ecs describe-services \\
  --cluster staging-ecs-cluster \\
  --services address-api \\
  --region ap-south-1
```

### Check task status

```bash
# List tasks
aws ecs list-tasks \\
  --cluster staging-ecs-cluster \\
  --service-name address-api \\
  --region ap-south-1

# Describe task
aws ecs describe-tasks \\
  --cluster staging-ecs-cluster \\
  --tasks TASK_ARN \\
  --region ap-south-1
```

### Check task logs

```bash
# Get log stream name from task description
aws logs get-log-events \\
  --log-group-name /ecs/staging-address-api \\
  --log-stream-name ecs/address-api/TASK_ID \\
  --region ap-south-1
```

### Force new deployment

```bash
aws ecs update-service \\
  --cluster staging-ecs-cluster \\
  --service address-api \\
  --force-new-deployment \\
  --region ap-south-1
```

## Performance monitoring

### Check RDS metrics

1. Go to [RDS Console](https://ap-south-1.console.aws.amazon.com/rds/home?region=ap-south-1)
2. Select your database instance
3. Click **Monitoring** tab
4. Check:
   - CPU utilization
   - Database connections
   - Read/Write IOPS
   - Freeable memory

### Check ECS metrics

1. Go to [ECS Console](https://ap-south-1.console.aws.amazon.com/ecs/home?region=ap-south-1)
2. Select your cluster
3. Select your service
4. Click **Metrics** tab
5. Check:
   - CPU utilization
   - Memory utilization
   - Task count

## Best practices

### Logging

- Use structured logging (JSON)
- Include request IDs for tracing
- Log at appropriate levels
- Don't log sensitive data (passwords, API keys)
- Include context in error logs

### Debugging

- Start with recent logs
- Use CloudWatch Insights for analysis
- Check metrics alongside logs
- Reproduce issues in staging first
- Document findings

### Performance

- Monitor response times
- Set up alerts for slow requests
- Optimize database queries
- Cache frequently accessed data
- Use connection pooling

## Next steps

- [Monitoring](/engine/address-api/operations/monitoring)
- [Common failures](/engine/address-api/operations/common-failures)
- [Database connection](/engine/address-api/operations/database-connection)
