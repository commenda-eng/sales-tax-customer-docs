---
title: Debugging
description: Debug issues and check logs for the Address API
---

The Address API uses AWS CloudWatch for centralized logging and Better Stack for monitoring and alerting.

## CloudWatch logs

All application logs are sent to AWS CloudWatch Logs.

### Log groups

| Environment | Log Group | Retention |
|-------------|-----------|-----------|
| Staging | `/ecs/staging-address-api` | 7 days |
| Production | `/ecs/prod-address-api` | 30 days |

### Accessing logs

#### Via AWS Console

1. Go to **AWS Console** → **CloudWatch** → **Log groups**
2. Search for `/ecs/staging-address-api` or `/ecs/prod-address-api`
3. Click on the log group
4. Click on a log stream (each ECS task has its own stream)
5. View logs

#### Via AWS CLI

**Staging:**
```bash
# List log streams
aws logs describe-log-streams \
  --log-group-name /ecs/staging-address-api \
  --order-by LastEventTime \
  --descending \
  --max-items 5 \
  --region ap-south-1 \
  --profile staging

# Tail logs
aws logs tail /ecs/staging-address-api \
  --follow \
  --region ap-south-1 \
  --profile staging
```

**Production:**
```bash
# Tail logs
aws logs tail /ecs/prod-address-api \
  --follow \
  --region ap-south-1 \
  --profile prod
```

### Log format

The Address API uses structured JSON logging with zerolog:

```json
{
  \"level\": \"info\",
  \"time\": 1734518400,
  \"message\": \"server started\",
  \"port\": \"8080\"
}
```

### Log levels

| Level | Description | Example |
|-------|-------------|---------|
| `debug` | Detailed debugging information | Database query details |
| `info` | General informational messages | Server started, request received |
| `warn` | Warning messages | Deprecated API usage |
| `error` | Error messages | Failed to geocode address |
| `fatal` | Fatal errors (server exits) | Missing required environment variables |

### Common log patterns

#### Server startup

```json
{\"level\":\"info\",\"port\":\"8080\",\"time\":1734518400,\"message\":\"server started\"}
```

#### Successful request

```json
{
  \"level\":\"info\",
  \"method\":\"POST\",
  \"path\":\"/api/v1/geoencode\",
  \"status\":200,
  \"latency_ms\":45,
  \"time\":1734518400,
  \"message\":\"request completed\"
}
```

#### Error

```json
{
  \"level\":\"error\",
  \"error\":\"failed to geocode address\",
  \"address\":\"invalid address\",
  \"time\":1734518400,
  \"message\":\"geocoding failed\"
}
```

#### Database query

```json
{
  \"level\":\"debug\",
  \"query\":\"SELECT * FROM address_cache WHERE original_address = $1\",
  \"duration_ms\":2,
  \"time\":1734518400,
  \"message\":\"database query executed\"
}
```

### Filtering logs

#### Filter by log level

In CloudWatch Logs Insights:

```
fields @timestamp, level, message
| filter level = \"error\"
| sort @timestamp desc
| limit 100
```

#### Filter by endpoint

```
fields @timestamp, method, path, status, latency_ms
| filter path = \"/api/v1/geoencode\"
| sort @timestamp desc
| limit 100
```

#### Find slow requests

```
fields @timestamp, method, path, latency_ms
| filter latency_ms > 1000
| sort latency_ms desc
| limit 50
```

#### Count errors by type

```
fields @timestamp, error
| filter level = \"error\"
| stats count() by error
```

## Better Stack monitoring

Better Stack provides external monitoring and alerting for the Address API.

### Monitored endpoints

| Endpoint | Check interval | Timeout |
|----------|----------------|---------|
| `/healthz` | 1 minute | 10 seconds |

### Metrics tracked

- **Uptime**: Percentage of time the service is available
- **Response time**: Average response time for health checks
- **Status codes**: Distribution of HTTP status codes
- **Error rate**: Percentage of failed requests

### Alerts

Better Stack sends alerts when:

- **Service is down**: Health check fails 3 times in a row
- **High response time**: Response time > 5 seconds for 5 minutes
- **High error rate**: Error rate > 5% for 10 minutes
- **Database connection issues**: Health check returns database error

### Alert channels

Alerts are sent to:
- **Slack**: `#alerts` channel
- **Email**: Team distribution list
- **PagerDuty**: For production critical alerts

### Viewing metrics

1. Go to [Better Stack dashboard](https://betterstack.com)
2. Select **Address API** project
3. View uptime, response time, and error metrics

## Debugging common issues

### Issue: High latency

**Symptoms**: Requests taking longer than usual

**Debug steps**:

1. Check CloudWatch logs for slow requests:
   ```
   fields @timestamp, path, latency_ms
   | filter latency_ms > 1000
   | sort latency_ms desc
   ```

2. Check database connection pool:
   ```bash
   curl https://address.in.commenda.io/healthz
   ```
   Look at `database_pool.acquired_connections` - if close to `max_connections`, the pool is exhausted

3. Check Google API response time:
   ```
   fields @timestamp, google_api_latency_ms
   | stats avg(google_api_latency_ms)
   ```

**Possible causes**:
- Database connection pool exhausted
- Google Geocoding API slow
- High traffic volume

### Issue: 500 errors

**Symptoms**: Internal server errors

**Debug steps**:

1. Find error logs:
   ```
   fields @timestamp, level, error, message
   | filter level = \"error\"
   | sort @timestamp desc
   ```

2. Check for specific error patterns:
   - \"failed to geocode address\" → Google API issue
   - \"database connection failed\" → RDS issue
   - \"missing required environment variables\" → Configuration issue

3. Check ECS task health:
   ```bash
   aws ecs describe-services \
     --cluster staging-ecs-cluster \
     --services address-api \
     --region ap-south-1
   ```

**Possible causes**:
- Google API key invalid or quota exceeded
- Database connection issues
- Missing environment variables

### Issue: Authentication failures

**Symptoms**: 401 or 403 errors

**Debug steps**:

1. Check authentication logs:
   ```
   fields @timestamp, status, path, error
   | filter status = 401 or status = 403
   | sort @timestamp desc
   ```

2. Verify API key exists:
   ```sql
   SELECT * FROM api_key WHERE key = 'the-api-key';
   ```

3. Check API key roles:
   ```sql
   SELECT key, roles FROM api_key WHERE key = 'the-api-key';
   ```

**Possible causes**:
- Invalid API key
- API key missing required role
- API key deleted

### Issue: Cache not working

**Symptoms**: Every request hits Google API

**Debug steps**:

1. Check cache hit rate:
   ```
   fields @timestamp, cache_hit
   | stats count() by cache_hit
   ```

2. Verify cache table has data:
   ```sql
   SELECT COUNT(*) FROM address_cache;
   ```

3. Check for cache errors:
   ```
   fields @timestamp, error
   | filter error like /cache/
   ```

**Possible causes**:
- Database connection issues
- Cache table empty
- Address string format mismatch (case-sensitive)

## Performance monitoring

### Request metrics

Track request performance in CloudWatch Logs Insights:

```
fields @timestamp, method, path, status, latency_ms
| stats 
    count() as total_requests,
    avg(latency_ms) as avg_latency,
    max(latency_ms) as max_latency,
    pct(latency_ms, 95) as p95_latency,
    pct(latency_ms, 99) as p99_latency
  by path
```

### Error rate

Calculate error rate:

```
fields @timestamp, status
| stats 
    count() as total,
    sum(status >= 500) as errors
| extend error_rate = (errors / total) * 100
```

### Database connection pool

Monitor connection pool usage:

```
fields @timestamp, database_pool.total_connections, database_pool.acquired_connections
| stats 
    avg(database_pool.acquired_connections) as avg_acquired,
    max(database_pool.acquired_connections) as max_acquired
```

## Troubleshooting tools

### Health check

```bash
curl https://address.in.commenda.io/healthz
```

Returns:
- API status
- Database connection pool metrics
- Database connectivity

### Test geocoding

```bash
curl -X POST https://address.in.commenda.io/api/v1/geoencode \
  -H \"x-commenda-key: your-api-key\" \
  -H \"Content-Type: application/json\" \
  -d '{\"address\": \"94108, CA, US\"}'
```

### Check ECS task status

```bash
aws ecs list-tasks \
  --cluster staging-ecs-cluster \
  --service-name address-api \
  --region ap-south-1 \
  --profile staging

aws ecs describe-tasks \
  --cluster staging-ecs-cluster \
  --tasks TASK_ARN \
  --region ap-south-1 \
  --profile staging
```

## Next steps

- [Common failures](/engine/address-api/operations/common-failures)
- [Database connection](/engine/address-api/operations/database-connection)
