---
title: Deployment
description: Deploy the Address API to staging and production
---

The Address API uses GitHub Actions for continuous deployment to AWS ECS Fargate. Deployments are triggered by creating GitHub releases.

## Deployment overview

| Environment | Trigger | AWS Account | Region |
|-------------|---------|-------------|--------|
| Staging | Pre-release tag (`v*-rc.*`) | 127214192604 | ap-south-1 |
| Production | Release tag (`v*`) | 429032495558 | ap-south-1 |

## Prerequisites

Before deploying, ensure:

1. **All PR checks pass**: Lint, format, build, tests
2. **PR is merged to main**: Merging does NOT trigger deployment
3. **You have release permissions**: Only maintainers can create releases

## Creating a release

### Deploy to staging

1. Go to the [Releases page](https://github.com/commenda-eng/address-api/releases)
2. Click **Draft a new release**
3. Click **Choose a tag**
4. Enter a pre-release tag: `v0.1.0-rc.1`
   - Format: `v{major}.{minor}.{patch}-rc.{release-candidate}`
   - Example: `v0.2.0-rc.1`, `v0.2.0-rc.2`
5. Set **Target**: `main`
6. Enter **Release title**: `v0.1.0-rc.1 - Staging Release`
7. Add **Release notes**: Describe what changed
8. ✅ Check **Set as a pre-release**
9. Click **Publish release**

### Deploy to production

1. Go to the [Releases page](https://github.com/commenda-eng/address-api/releases)
2. Click **Draft a new release**
3. Click **Choose a tag**
4. Enter a production tag: `v0.1.0`
   - Format: `v{major}.{minor}.{patch}`
   - Example: `v0.2.0`, `v1.0.0`
5. Set **Target**: `main`
6. Enter **Release title**: `v0.1.0 - Production Release`
7. Add **Release notes**: Describe what changed
8. ❌ **Do NOT check** \"Set as a pre-release\"
9. Click **Publish release**

## Deployment workflow

When you create a release, GitHub Actions automatically:

### 1. Build Docker image

```yaml
- name: Build Docker image
  run: docker build -t address-api:${{ github.ref_name }} .
```

### 2. Push to ECR

```yaml
- name: Push to ECR
  run: |
    docker tag address-api:${{ github.ref_name }} $ECR_REGISTRY/address-api:${{ github.ref_name }}
    docker push $ECR_REGISTRY/address-api:${{ github.ref_name }}
```

### 3. Update ECS task definition

```yaml
- name: Update task definition
  run: |
    aws ecs register-task-definition \
      --family address-api \
      --container-definitions '[{\"name\":\"address-api\",\"image\":\"$ECR_IMAGE\"}]'
```

### 4. Deploy to ECS

```yaml
- name: Deploy to ECS
  run: |
    aws ecs update-service \
      --cluster $CLUSTER_NAME \
      --service address-api \
      --task-definition address-api:$REVISION \
      --force-new-deployment
```

### 5. Wait for deployment

The workflow waits for the ECS service to stabilize (all tasks running the new version).

## Monitoring deployment

### View deployment progress

1. Go to [GitHub Actions](https://github.com/commenda-eng/address-api/actions)
2. Click on the running workflow
3. Monitor the deployment steps

### Check ECS deployment

**Staging:**
```bash
aws ecs describe-services \
  --cluster staging-ecs-cluster \
  --services address-api \
  --region ap-south-1 \
  --profile staging
```

**Production:**
```bash
aws ecs describe-services \
  --cluster prod-ecs-cluster \
  --services address-api \
  --region ap-south-1 \
  --profile prod
```

### Verify deployment

**Staging:**
```bash
curl https://address.in.staging.commenda.io/healthz
```

**Production:**
```bash
curl https://address.in.commenda.io/healthz
```

Expected response:
```json
{
  \"api\": true,
  \"database_pool\": {
    \"total_connections\": 12,
    \"acquired_connections\": 0,
    \"idle_connections\": 12,
    \"max_connections\": 48,
    \"acquire_duration_ms\": 2
  }
}
```

## Rollback

If a deployment fails or introduces issues, you can rollback to a previous version.

### Option 1: Redeploy previous release

1. Go to [Releases](https://github.com/commenda-eng/address-api/releases)
2. Find the last working release
3. Click **Edit release**
4. Click **Update release** (this triggers redeployment)

### Option 2: Manual ECS rollback

**Staging:**
```bash
# List task definitions
aws ecs list-task-definitions \
  --family-prefix address-api \
  --region ap-south-1 \
  --profile staging

# Rollback to previous version
aws ecs update-service \
  --cluster staging-ecs-cluster \
  --service address-api \
  --task-definition address-api:PREVIOUS_REVISION \
  --force-new-deployment \
  --region ap-south-1 \
  --profile staging
```

**Production:**
```bash
# List task definitions
aws ecs list-task-definitions \
  --family-prefix address-api \
  --region ap-south-1 \
  --profile prod

# Rollback to previous version
aws ecs update-service \
  --cluster prod-ecs-cluster \
  --service address-api \
  --task-definition address-api:PREVIOUS_REVISION \
  --force-new-deployment \
  --region ap-south-1 \
  --profile prod
```

## Deployment checklist

Before deploying to production:

- [ ] Staging deployment successful
- [ ] Smoke tests pass on staging
- [ ] No errors in CloudWatch logs
- [ ] Health check endpoint responds correctly
- [ ] Database migrations applied successfully
- [ ] Better Stack shows no alerts
- [ ] API key authentication works
- [ ] Geocoding endpoint returns correct results
- [ ] Ingestion endpoint works correctly

## Common deployment issues

### Error: \"Task failed to start\"

**Cause**: Container fails to start (missing env vars, port conflicts, etc.)

**Fix**:
1. Check CloudWatch logs for error messages
2. Verify environment variables in ECS task definition
3. Ensure secrets are accessible from Secrets Manager

### Error: \"Service failed to stabilize\"

**Cause**: New tasks keep failing health checks

**Fix**:
1. Check ALB target group health checks
2. Verify the `/healthz` endpoint is responding
3. Check database connectivity

### Error: \"Image not found in ECR\"

**Cause**: Docker image wasn't pushed to ECR

**Fix**:
1. Check GitHub Actions logs for build/push errors
2. Verify ECR repository exists
3. Ensure AWS credentials are valid

### Deployment takes too long

**Cause**: ECS is waiting for old tasks to drain

**Fix**:
1. Check ECS service deployment configuration
2. Reduce `deregistration_delay` in target group settings
3. Ensure old tasks are terminating properly

## Deployment best practices

### Versioning

- **Semantic versioning**: Use `v{major}.{minor}.{patch}` format
- **Staging first**: Always deploy to staging before production
- **Increment versions**: Don't reuse version numbers

### Release notes

Include in release notes:
- **Features**: New functionality added
- **Fixes**: Bugs fixed
- **Breaking changes**: API changes that require client updates
- **Database migrations**: Schema changes applied

### Timing

- **Deploy during low traffic**: Minimize impact on users
- **Monitor after deployment**: Watch logs and metrics for 15-30 minutes
- **Have rollback plan**: Know how to quickly revert if needed

## Next steps

- [Database connection](/engine/address-api/operations/database-connection)
- [Debugging guide](/engine/address-api/operations/debugging)
- [Common failures](/engine/address-api/operations/common-failures)
